#!/bin/bash

logfile=$(mktemp)
backupdir=/var/backups/mysql
unixtimestamp=$(date '+%s')
day=$(date -d "@${unixtimestamp}" '+%F')
hour=$(date -d "@${unixtimestamp}" '+%R')

[ ! -d ${backupdir}/${day}/${hour} ] && mkdir -p ${backupdir}/${day}/${hour}/dumps

if [[ "${hour}" == "00:00" ]]
then
    /usr/bin/innobackupex --no-timestamp --databases "cloud cloud_usage" --slave-info --safe-slave-backup --no-lock ${backupdir}/${day}/${hour}/full >${logfile} 2>&1
    mv ${logfile} ${backupdir}/${day}/${hour}/full/innobackupex.log
fi

for database in $(mysql -sNe "show databases" | grep -vE 'information_schema|performance_schema')
do
    echo "$(date '+%F %T') Dumping database ${database} ..." | tee -a ${logfile}
    mysqldump -E ${database} 2>> ${logfile} | gzip > ${backupdir}/${day}/${hour}/dumps/${database}.sql.gz
done
mv ${logfile} ${backupdir}/${day}/${hour}/dumps/mysqldump.log



echo "Cleanup..."

if [[ "${hour}" == "00:00" ]]
then

    # Delete the folder from 8 days ago, unless it is the 1st, 8th, 15th, 22th or 29th .
    date=$(date -d "@$[ unixtimestamp - 8 * 86400 ]" '+%F')
    dayofthemonth=$(date -d "${date}" '+%d')

    if [[ ! "${dateofthemonth}" =~ 01$|08$|15$|22$|29$ ]]
    then
        dir=${backupdir}/${date}
        echo "Removing ${dir} ..."
        [[ -d "${dir}" ]] && rm -r ${dir}
    fi

else

    # Delete the folder from 96 hours ago
    date=$(date -d "@$[ unixtimestamp - 4 * 86400 ]" '+%F')
    dir=${backupdir}/${date}/${hour}
    echo "Removing ${dir} ..."
    [[ -d "${dir}" ]] && rm -r ${dir}

fi

# Delete the folder from 48 hours ago, unless it is on each 6th hour .
if [[ ! "${hour}" =~ 00:|06:|12:|18: ]]
then
    date=$(date -d "@$[ unixtimestamp - 2 * 86400 ]" '+%F')
    dir=${backupdir}/${date}/${hour}
    echo "Removing ${dir} ..."
    [[ -d "${dir}" ]] && rm -r ${dir}
fi


# Delete the folder from 24 hours ago, unless it is on each 3rd hour .
if [[ ! "${hour}" =~ 00:|03:|06:|09:|12:|15:|18:|21: ]]
then
    date=$(date -d "@$[ unixtimestamp - 86400 ]" '+%F')
    dir=${backupdir}/${date}/${hour}
    echo "Removing ${dir} ..."
    [[ -d "${dir}" ]] && rm -r ${dir}
fi

