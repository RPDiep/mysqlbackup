#!/bin/bash

logfile=$(mktemp)
backupdir=/var/backups/mysql
unixtimestamp=$(date '+%s')
day=$(date -d "@${unixtimestamp}" '+%F')
hour=$(date -d "@${unixtimestamp}" '+%R')

[ ! -d ${backupdir}/${day}/${hour} ] && mkdir -p ${backupdir}/${day}/${hour}/dumps

if [[ "${hour}" == "00:00" ]]
then
    /usr/bin/innobackupex --no-timestamp --databases "cloud cloud_usage" --slave-info --safe-slave-backup --no-lock ${backupdir}/${day}/${hour}/full >${logfile} 2>&1
    mv ${logfile} ${backupdir}/${day}/${hour}/full/innobackupex.log
fi

for database in $(mysql -sNe "show databases" | grep -vE 'information_schema|performance_schema')
do 
    echo "$(date '+%F %T') Dumping database ${database} ..." | tee -a ${logfile}
    mysqldump -E ${database} 2>> ${logfile} | gzip > ${backupdir}/${day}/${hour}/dumps/${database}.sql.gz
done
mv ${logfile} ${backupdir}/${day}/${hour}/dumps/mysqldump.log



echo "Cleanup..."

# Delete the folder from 8 days ago, unless it is the 1st, 8th, 15th, 22th or 29th .

if [[ "${hour}" == "00:00" ]]
then
    date=$(date -d "@$[ unixtimestamp - 8 * 86400 ]" '+%F')
    dayofthemonth=$(date -d "${date}" '+%d')
    
    if [[ "${dateofthemonth}" =~ 01$|08$|15$|22$|29$ ]]
    then
        for dir in $(ls -d ${backupdir}/${date}/* 2>/dev/null | grep -v '00:00')
        do
            echo "Removing ${dir} ..."
            #rm -r "${dir}"
        done 
    else
        echo "Removing ${backupdir}/${date} ..."
        #rm -r ${backupdir}/${date}
    fi
fi

# Delete the folder from 24 hours ago, unless it is on each 3rd hour .

date=$(date -d "@$[ unixtimestamp - 86400 ]" '+%F')

if [[ ! "${hour}" =~ 00|03|06|09|12|15|18|21 ]]
then
    echo "Removing ${backupdir}/${date}/${hour} ..."
    #rm -r ${backupdir}/${date}/${hour}
fi

